ifdef IOS
	CFLAGS+= -I. 
	ifndef IOSARCH
		IOSARCH=armv7
	endif
	LIBS+= $(IOSARCHDIR)/lib/libsoup-2.4.a $(IOSARCHDIR)/lib/libnice.a $(IOSARCHDIR)/lib/libgthread-2.0.a $(IOSARCHDIR)/lib/libgio-2.0.a $(IOSARCHDIR)/lib/libgobject-2.0.a $(IOSARCHDIR)/lib/libglib-2.0.a $(IOSDIR)/lib/libffi.a $(IOSARCHDIR)/lib/libgmodule-2.0.a $(IOSARCHDIR)/lib/libgio-2.0.a $(IOSARCHDIR)/lib/libgssdp-1.0.a $(IOSARCHDIR)/lib/libsoup-2.4.a $(IOSARCHDIR)/lib/libgio-2.0.a -lz $(IOSARCHDIR)/lib/libglib-2.0.a $(IOSARCHDIR)/lib/libintl.a -ldl -lm
	#LIBFILELIST=$(shell echo "${LIBS}" | sed 's/[ ]-[^ ]*/ /g')
	LIBFILELIST=$(shell find "${IOSDIR}/lib" "${IOSARCHDIR}/lib" -name "*.a" | xargs echo)
	EXTRA=-DARM=1 -DIOTC_CLIENT=1
else
ifdef GRAIN
	CHAINDIR=/usr/local/src/arm-none-linux-gnueabi-4.4.0_ARMv5TE/arm-none-linux-gnueabi
	PROJDIR=/usr/local/iotc-dependencies
	CROSS=arm-none-linux-gnueabi-
	CFLAGS+= -I$(CHAINDIR)/include -I$(PROJDIR)/include -I$(PROJDIR)/include/glib -I$(PROJDIR)/include/gmodule
	LDFLAGS+= -L$(CHAINDIR)/lib -L$(PROJDIR)/lib
	LIBS+= $(PROJDIR)/lib/arm-none-linux-gnueabi/libsoup-2.4.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libnice.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgthread-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgio-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgobject-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libglib-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libffi.a -lresolv $(PROJDIR)/lib/arm-none-linux-gnueabi/libgmodule-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgupnp-igd-1.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgupnp-1.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgio-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgssdp-1.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libsoup-2.4.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libgio-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libxml2.a  $(PROJDIR)/lib/arm-none-linux-gnueabi/libuuid.a $(CHAINDIR)/lib/libz.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libglib-2.0.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libmosquitto.a $(PROJDIR)/lib/arm-none-linux-gnueabi/libcares.a -lpthread -ldl -lm -lrt -lssl
	EXTRA=-DARM=1 -DGRAIN=1
else
ifdef GRAIN8136
	GMDIR=/usr/local/iotc-gm8136/arm-linux-3.3/toolchain_gnueabi-4.4.0_ARMv5TE/usr/arm-unknown-linux-uclibcgnueabi/sysroot/usr
	CROSS=arm-unknown-linux-uclibcgnueabi-
	CFLAGS+= -I. -I$(GMDIR)/include -I$(GMDIR)/include/glib-2.0 -I$(GMDIR)/include/glib-2.0/glib -I$(GMDIR)/lib/glib-2.0/include -I$(GMDIR)/include/libsoup-2.4/ -I$(GMDIR)/include/gssdp-1.0
	LDFLAGS+= -L$(GMDIR)/lib
	LIBS+= $(GMDIR)/lib/libsoup-2.4.a $(GMDIR)/lib/libnice.a $(GMDIR)/lib/libgthread-2.0.a $(GMDIR)/lib/libgio-2.0.a $(GMDIR)/lib/libgobject-2.0.a $(GMDIR)/lib/libglib-2.0.a $(GMDIR)/lib/libffi.a -lresolv $(GMDIR)/lib/libgmodule-2.0.a $(GMDIR)/lib/libgio-2.0.a $(GMDIR)/lib/libgssdp-1.0.a $(GMDIR)/lib/libsoup-2.4.a $(GMDIR)/lib/libgio-2.0.a $(GMDIR)/lib/libxml2.a  $(GMDIR)/lib/libuuid.a $(GMDIR)/../../lib/libz.a $(GMDIR)/lib/libglib-2.0.a $(GMDIR)/lib/libintl.a $(GMDIR)/lib/libmosquitto.a $(GMDIR)/lib/libcares.a -ldl -lm -lrt -lssl -lcrypto
	EXTRA=-DARM=1 -DIFADDRS_NOT_SUPPORTED=1
else
ifdef ANDROID
	ANDDIR=/usr/local/android-ndk-r10e/platforms/android-9/arch-arm/usr
	CROSS=arm-linux-androideabi-
	CFLAGS+= -I. -I$(ANDDIR)/include -I$(ANDDIR)/include/glib-2.0 -I$(ANDDIR)/include/glib-2.0/glib -I$(ANDDIR)/lib/glib-2.0/include -I$(ANDDIR)/include/libsoup-2.4/ -I$(ANDDIR)/include/gssdp-1.0 --sysroot=$(ANDDIR)/..
	LDFLAGS+= -L/usr/local/android-ndk-r10e/platforms/android-9/arch-arm/usr/lib
	LIBS+= $(ANDDIR)/lib/libsoup-2.4.a $(ANDDIR)/lib/libnice.a $(ANDDIR)/lib/libgthread-2.0.a $(ANDDIR)/lib/libgio-2.0.a $(ANDDIR)/lib/libgobject-2.0.a $(ANDDIR)/lib/libglib-2.0.a $(ANDDIR)/lib/libffi.a $(ANDDIR)/lib/libgmodule-2.0.a $(ANDDIR)/lib/libgio-2.0.a $(ANDDIR)/lib/libgssdp-1.0.a $(ANDDIR)/lib/libsoup-2.4.a $(ANDDIR)/lib/libgio-2.0.a $(ANDDIR)/lib/libxml2.a $(ANDDIR)/lib/libuuid.a -lz $(ANDDIR)/lib/libglib-2.0.a $(ANDDIR)/lib/libiconv.a $(ANDDIR)/lib/libintl.a -ldl -lm $(ANDDIR)/lib/libssl.a $(ANDDIR)/lib/libcrypto.a
	EXTRA=-DIOTC_CLIENT=1 -DIFADDRS_NOT_SUPPORTED=1
else
ifdef RASPBERRY
	PIDIR=/usr/local/iotc-raspberry/gcc-linaro-arm-linux-gnueabihf-raspbian/arm-linux-gnueabihf
	CROSS=arm-linux-gnueabihf-
	CFLAGS+= -I. -I$(PIDIR)/include -I$(PIDIR)/include/glib-2.0 -I$(PIDIR)/include/glib-2.0/glib -I$(PIDIR)/lib/glib-2.0/include -I$(PIDIR)/include/libsoup-2.4/ -I$(PIDIR)/include/gssdp-1.0
	LDFLAGS+= -L$(PIDIR)/lib
	LIBS+= $(PIDIR)/lib/libsoup-2.4.a $(PIDIR)/lib/libnice.a $(PIDIR)/lib/libgthread-2.0.a $(PIDIR)/lib/libgio-2.0.a $(PIDIR)/lib/libgobject-2.0.a $(PIDIR)/lib/libglib-2.0.a $(PIDIR)/lib/libffi.a -lresolv $(PIDIR)/lib/libgmodule-2.0.a $(PIDIR)/lib/libgupnp-igd-1.0.a $(PIDIR)/lib/libgupnp-1.0.a $(PIDIR)/lib/libgio-2.0.a $(PIDIR)/lib/libgssdp-1.0.a $(PIDIR)/lib/libsoup-2.4.a $(PIDIR)/lib/libgio-2.0.a $(PIDIR)/lib/libxml2.a $(PIDIR)/lib/libuuid.a -lz $(PIDIR)/lib/libglib-2.0.a $(PIDIR)/lib/libmosquitto.a $(PIDIR)/lib/libcares.a -lpthread -ldl -lm -lrt $(PIDIR)/lib/libssl.a $(PIDIR)/lib/libcrypto.a
	EXTRA=-DARM=1
else
ifdef RAYSHARP
	RSDIR=/opt/hisi-linux-nptl/arm-hisiv100-linux/target/usr
	CROSS=arm-hisiv100-linux-uclibcgnueabi-
	CFLAGS+= -I. -I$(RSDIR)/include -I$(RSDIR)/include/glib-2.0 -I$(RSDIR)/include/glib-2.0/glib -I$(RSDIR)/lib/glib-2.0/include -I$(RSDIR)/include/libsoup-2.4/ -I$(RSDIR)/include/gssdp-1.0
	LDFLAGS+= -L$(RSDIR)/lib
	LIBS+= $(RSDIR)/lib/libsoup-2.4.a $(RSDIR)/lib/libnice.a $(RSDIR)/lib/libgthread-2.0.a $(RSDIR)/lib/libgio-2.0.a $(RSDIR)/lib/libgobject-2.0.a $(RSDIR)/lib/libglib-2.0.a $(RSDIR)/lib/libffi.a -lresolv $(RSDIR)/lib/libgmodule-2.0.a $(RSDIR)/lib/libgio-2.0.a $(RSDIR)/lib/libgssdp-1.0.a $(RSDIR)/lib/libsoup-2.4.a $(RSDIR)/lib/libgio-2.0.a $(RSDIR)/lib/libxml2.a $(RSDIR)/lib/libuuid.a $(RSDIR)/lib/libz.a $(RSDIR)/lib/libglib-2.0.a $(RSDIR)/lib/libiconv.a $(RSDIR)/lib/libintl.a $(RSDIR)/lib/libmosquitto.a $(RSDIR)/lib/libcares.a -lpthread -ldl -lm -lrt $(RSDIR)/lib/libssl.a $(RSDIR)/lib/libcrypto.a
	EXTRA=-DARM=1
else
ifdef WUHAN
	WUDIR=/opt/goke/ct_uClibc/4.6.1/usr/arm-goke-linux-uclibcgnueabi/sysroot/usr
	CROSS=arm-goke-linux-uclibcgnueabi-
	CFLAGS+= -I. -I$(WUDIR)/include -I$(WUDIR)/include/glib-2.0 -I$(WUDIR)/include/glib-2.0/glib -I$(WUDIR)/lib/glib-2.0/include -I$(WUDIR)/include/libsoup-2.4/ -I$(WUDIR)/include/gssdp-1.0
	LIBS+= $(WUDIR)/lib/libsoup-2.4.a $(WUDIR)/lib/libnice.a $(WUDIR)/lib/libgthread-2.0.a $(WUDIR)/lib/libgio-2.0.a $(WUDIR)/lib/libgobject-2.0.a $(WUDIR)/lib/libglib-2.0.a $(WUDIR)/lib/libffi.a -lresolv $(WUDIR)/lib/libgmodule-2.0.a $(WUDIR)/lib/libgio-2.0.a $(WUDIR)/lib/libgssdp-1.0.a $(WUDIR)/lib/libsoup-2.4.a $(WUDIR)/lib/libgio-2.0.a $(WUDIR)/lib/libxml2.a $(WUDIR)/lib/libuuid.a $(WUDIR)/lib/libz.a $(WUDIR)/lib/libglib-2.0.a $(WUDIR)/lib/libiconv.a $(WUDIR)/lib/libintl.a $(WUDIR)/lib/libmosquitto.a $(WUDIR)/lib/libcares.a -lpthread -ldl -lm -lrt -lssl -lcrypto
	EXTRA=-DARM=1
else
	PROJDIR=/usr/local/iotc-dependencies
	CFLAGS+= -I$(PROJDIR)/include -I$(PROJDIR)/include/glib -I$(PROJDIR)/include/gmodule
	LDFLAGS+= -L$(PROJDIR)/lib
	LIBS+= $(PROJDIR)/lib/libsoup-2.4.a $(PROJDIR)/lib/libnice.a $(PROJDIR)/lib/libgthread-2.0.a $(PROJDIR)/lib/libgio-2.0.a $(PROJDIR)/lib/libgobject-2.0.a $(PROJDIR)/lib/libglib-2.0.a $(PROJDIR)/lib/libffi.a -lresolv $(PROJDIR)/lib/libgmodule-2.0.a $(PROJDIR)/lib/libgupnp-igd-1.0.a $(PROJDIR)/lib/libgupnp-1.0.a $(PROJDIR)/lib/libgio-2.0.a $(PROJDIR)/lib/libgssdp-1.0.a $(PROJDIR)/lib/libsoup-2.4.a $(PROJDIR)/lib/libgio-2.0.a $(PROJDIR)/lib/libxml2.a $(PROJDIR)/lib/libuuid.a -lz $(PROJDIR)/lib/libglib-2.0.a $(PROJDIR)/lib/libmosquitto.a $(PROJDIR)/lib/libcares.a -lpthread -ldl -lm -lrt -lssl -lcrypto
	EXTRA=
endif # WUHAN
endif # RAYSHARP
endif # RASPBERRY
endif # ANDROID
endif # GM8136
endif # GRAIN
endif # IOS
ifdef NODEBUG
	DEBUG=
else
	CFLAGS+= -g -O0 -finstrument-functions -rdynamic
	DEBUG=-DDEBUG=1
endif

ifdef CROSS
	CC=$(CROSS)gcc
endif # CROSS

STRIP=$(CROSS)strip
CFLAGS+= -Wall -I.

SOURCES=$(wildcard *.c)
OBJECTS=$(patsubst %.c, %.o, $(SOURCES))
EXECUTABLE=device
VERSION='"0.0.1"'

all: $(EXECUTABLE)

$(EXECUTABLE): $(OBJECTS)
	@echo "Link executable: $@"
	@$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS) $(LIBS)
ifdef NODEBUG
	@echo "Strip executable: $@"
	@$(STRIP) $@
endif
	@cp -p device client

library: $(OBJECTS)
	@echo "Creating static library"
ifdef IOS
	@echo "1: $(IOSDIR)"
	@echo "2: $(IOSARCHDIR)"
	@echo "3: $(LIBS)"
	@echo "4: $(LIBFILELIST)"
	@$(LIBTOOL) -static -arch_only $(IOSARCH) -syslibroot $(SDKROOT) $^ $(LIBFILELIST) -o "$(IOSOUTDIR)"/libiotc-ios.a
	@cp -p library.h "$(IOSOUTDIR)"/
else
ifdef ANDROID
	@$(AR) rcs libiotc-android.a $^
	@$(AR) -M < iotcandroid.mri
	@rm libiotc-android.a
else
ifdef GRAIN
	@$(AR) rcs libiotctemp.a $^
	@$(AR) -M < iotcgm.mri
	@rm libiotctemp.a
else
ifdef GRAIN8136
	@$(AR) rcs libiotctemp.a $^
	@$(AR) -M < iotcgm8136.mri
	@rm libiotctemp.a
else
	@echo "No library rules for the specified target!"
endif # GRAIN8136
endif # GRAIN
endif # ANDROID
endif # IOS

%.o: %.c
	@echo "Make object: $<"
	@$(CC) $(CFLAGS) -c $< -DVERSION=$(VERSION) $(DEBUG) $(EXTRA)

.PHONY: clean

clean:
	@rm -f *.o *.a *.so *.so.* $(EXECUTABLE) client
	@echo "Removing *.o, libraries and $(EXECUTABLE) executables"
