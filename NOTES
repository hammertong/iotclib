
SORGENTI
--------

Aggiornamento da inviare a Padova

zip -r updates_`date +%Y%m%d%H%M`.zip device_certs/ sssdp.c

Troubleshooting device generazioje certificato

Errore ella creazione del certificato:
mysql > update Uid set dev_cert = '0' where uid = 'ELKI251804065901ADE7' 
db/serial.txt incrementato di 1 (diceva giÃ  revocato per il current serial)


AGGIUNTA MANUALE DEVICE SUL BACKEND
-----------------------------------

1) ASSICURARSI CHE IL DEVICE SIA CERTIFICABILE SU backend:

mysql > select uid, type, dev_cert from Uid where uid in ('ELKI251804065901ADE7', 'ELKI251804065901ADE6') ;

mysql > update Uid set dev_cert = '0' where uid = 'ELKI251804065901ADE6';

2) AGGIUNGERE ALL'UTENTE DI LOGIN HTTP ICE (dileo) IL DEVICE TRAMITE API  

uc_env -s
set www.cloud.urmet.com

impostare user/paas dileo su ~/bin/uc.conf 

uc_login 
uc -o json /sites/
uc -m put -f new_device.json -o raw /site/6/device/ELKI251804065901ADE6
uc -o json /site/6


TROUBLESHOOTING CERTIFICATI
---------------------------

REVOCA MANUALE da nodo qualsiasi

#export MY_UID=ELKI251804065901ADE7
export MY_UID=ELKI251804065901ADE6
export CA_CONFIG=/etc/UrmetIoTc_CA/config/caconfig.cnf
export CA_KEYPASS=UrmC4_2015_I0T5
export CERTIFICATES_DIR=/etc/UrmetIoTc_CA/device_certs
/usr/bin/openssl ca -config $CA_CONFIG -key $CA_KEYPASS -revoke $CERTIFICATES_DIR/$MY_UID.pem


tcpdump::

POST /tool/devapi/public/index.php/x509_device_register HTTP/1.1
User-Agent: IoTl/0.0.1
Accept: */*
Host: www.cloud.urmet.com
Connection: Close
Content-Type: application/x-www-form-urlencoded
Content-Length: 738

csr=-----BEGIN%20CERTIFICATE%20REQUEST-----%0AMIIBwTCCASoCAQAwgYAxCzAJBgNVBAYTAklUMQ4wDAYDVQQIDAVJdGFseTEOMAwG%0AA1UEBwwFVHVyaW4xFTATBgNVBAoMDFVybWV0IHMucC5hLjEbMBkGA1UECwwSVmlk%0AZW8gU3VydmVpbGxhbmNlMR0wGwYDVQQDDBRFTEtJMjUxODA0MDY1OTAxQURFNjCB%0AnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEArYhLRnNd9p1JP1rECsANmy%2F%2FkIMZ%0A1ykwp4gms%2FlSCYtkattvLbqhT9mmGJ7rnlnfWZqi%2BFNAVI1kmlnk4WUFCKYgriGp%0AANQb7Dp2tkzc8%2FLraqLJfdTcopZYHj7zrvIZnuVvtliSou8iWL9l5NrpV%2BKUggq2%0AP6UXgg30%2Bg92NikCAwEAAaAAMA0GCSqGSIb3DQEBBAUAA4GBAI4imDD2Iu9%2FnWTs%0AKpab7FttOL06gAHsZKPvVEiPfsi884FneEdOEqkXmPNl03QueWFeBSVNH4WOY9yJ%0AB225NzweM7ht%2Bw3MUfyHtrRlIYyA69cF09m59mQYYBh6UDxtOcu3QkD7xfiXJben%0AQmB0OZnWMDG806UYOC3NLQhqATdW%0A-----END%20CERTIFICATE%20REQUEST-----%0A


Collaudo da linea di comando
-----------------------------

Richiesta firma CSR da device -> nodo endpoint
curl -vk -H "Content-Type: application/x-www-form-urlencoded" -X POST -d "csr=-----BEGIN%20CERTIFICATE%20REQUEST-----%0AMIIBwTCCASoCAQAwgYAxCzAJBgNVBAYTAklUMQ4wDAYDVQQIDAVJdGFseTEOMAwG%0AA1UEBwwFVHVyaW4xFTATBgNVBAoMDFVybWV0IHMucC5hLjEbMBkGA1UECwwSVmlk%0AZW8gU3VydmVpbGxhbmNlMR0wGwYDVQQDDBRFTEtJMjUxODA0MDY1OTAxQURFNjCB%0AnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEArYhLRnNd9p1JP1rECsANmy%2F%2FkIMZ%0A1ykwp4gms%2FlSCYtkattvLbqhT9mmGJ7rnlnfWZqi%2BFNAVI1kmlnk4WUFCKYgriGp%0AANQb7Dp2tkzc8%2FLraqLJfdTcopZYHj7zrvIZnuVvtliSou8iWL9l5NrpV%2BKUggq2%0AP6UXgg30%2Bg92NikCAwEAAaAAMA0GCSqGSIb3DQEBBAUAA4GBAI4imDD2Iu9%2FnWTs%0AKpab7FttOL06gAHsZKPvVEiPfsi884FneEdOEqkXmPNl03QueWFeBSVNH4WOY9yJ%0AB225NzweM7ht%2Bw3MUfyHtrRlIYyA69cF09m59mQYYBh6UDxtOcu3QkD7xfiXJben%0AQmB0OZnWMDG806UYOC3NLQhqATdW%0A-----END%20CERTIFICATE%20REQUEST-----%0A" http://www.cloud.urmet.com/tool/devapi/public/index.php/x509_device_register > ~/Scrivania/error.html

Richiesta firma CSR postata da php su nodo endpoint -> nodo CA (scatenata da quella di sopra in backend) 
curl -vk -H "Content-Type: application/x-www-form-urlencoded" -X POST -d "devuid=ELKI251804065901ADE6&csr=-----BEGIN+CERTIFICATE+REQUEST-----%0AMIIBwTCCASoCAQAwgYAxCzAJBgNVBAYTAklUMQ4wDAYDVQQIDAVJdGFseTEOMAwG%0AA1UEBwwFVHVyaW4xFTATBgNVBAoMDFVybWV0IHMucC5hLjEbMBkGA1UECwwSVmlk%0AZW8gU3VydmVpbGxhbmNlMR0wGwYDVQQDDBRFTEtJMjUxODA0MDY1OTAxQURFNjCB%0AnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEArYhLRnNd9p1JP1rECsANmy%2F%2FkIMZ%0A1ykwp4gms%2FlSCYtkattvLbqhT9mmGJ7rnlnfWZqi%2BFNAVI1kmlnk4WUFCKYgriGp%0AANQb7Dp2tkzc8%2FLraqLJfdTcopZYHj7zrvIZnuVvtliSou8iWL9l5NrpV%2BKUggq2%0AP6UXgg30%2Bg92NikCAwEAAaAAMA0GCSqGSIb3DQEBBAUAA4GBAI4imDD2Iu9%2FnWTs%0AKpab7FttOL06gAHsZKPvVEiPfsi884FneEdOEqkXmPNl03QueWFeBSVNH4WOY9yJ%0AB225NzweM7ht%2Bw3MUfyHtrRlIYyA69cF09m59mQYYBh6UDxtOcu3QkD7xfiXJben%0AQmB0OZnWMDG806UYOC3NLQhqATdW%0A-----END+CERTIFICATE+REQUEST-----%0A&" https://nod4-iotc.c.urmet-gcp-iotc.internal:4043/index.php/sign_devcert/ > ~/Scrivania/error2.html



